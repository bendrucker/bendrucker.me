---
import { sql } from "kysely";
import Layout from "../../layouts/Layout.astro";
import Main from "../../layouts/Main.astro";
import { SITE } from "../../config";
import ActivityTimeline from "../../components/activity/ActivityTimeline.vue";
import type { Repo } from "../../components/activity/composables/useActivityApi";
import { getDb } from "@/db";
import { repoQuery, mapRepoRow, queryRepos } from "./code/_query";
import { formatReposMarkdown } from "./code/_markdown";
import { logger } from "@workspace/logger";

const accept = Astro.request.headers.get("accept") ?? "";

if (accept.includes("text/markdown")) {
  const db = getDb(Astro.locals);
  const data = await queryRepos(db, {});
  return new Response(formatReposMarkdown(data.repos, data.total), {
    headers: { "Content-Type": "text/markdown; charset=utf-8" },
  });
}

let initialRepos: Repo[] = [];
let initialTotal = 0;
let initialHasMore = false;
let initialCursor: string | null = null;

try {
  const db = getDb(Astro.locals);

  const countResult = await db
    .selectFrom("repos")
    .innerJoin("repoActivity", "repoActivity.repoId", "repos.id")
    .select(sql<number>`count(distinct ${sql.ref("repos.id")})`.as("total"))
    .executeTakeFirstOrThrow();
  initialTotal = countResult.total;

  const results = await repoQuery(db)
    .orderBy(sql`last_activity`, "desc")
    .limit(21)
    .execute();

  initialHasMore = results.length > 20;
  const pageResults = initialHasMore ? results.slice(0, 20) : results;

  if (pageResults.length > 0) {
    const last = pageResults[pageResults.length - 1];
    initialCursor = `${last.lastActivity}|${last.id}`;
  }

  initialRepos = pageResults.map(mapRepoRow);
} catch (error) {
  logger.error({ error }, "Failed to load activity data");
}
---

<Layout title={`Activity: Code | ${SITE.title}`} description="My public GitHub activity." ogImage="/activity/code/og.png" sourcePath="src/pages/activity/code.astro">
  <Main pageTitle="Activity: Code" pageDesc="This page summarizes my GitHub activity by last contribution to each repository. It is an index of software projects I work on in public.">
    <section>
      <ActivityTimeline
        client:load
        initialRepos={initialRepos}
        initialTotal={initialTotal}
        initialHasMore={initialHasMore}
        initialCursor={initialCursor}
        username={SITE.githubUsername}
      />
    </section>
  </Main>
</Layout>
