name: Cleanup

on:
  pull_request:
    types: [closed]

permissions:
  deployments: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ§¹ Mark PR deployment as inactive"
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ENVIRONMENT="pr-${{ github.event.number }}"
          
          # Get all deployments for this environment
          # Query all deployments and filter by environment since ref filtering isn't reliable
          DEPLOYMENTS=$(gh api repos/${{ github.repository }}/deployments \
            --jq '.[] | select(.environment == "'$ENVIRONMENT'") | .id')
          
          # Mark each deployment as inactive
          for DEPLOYMENT_ID in $DEPLOYMENTS; do
            gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
              --method POST \
              --field state=inactive \
              --field description="PR closed - environment destroyed"
          done
